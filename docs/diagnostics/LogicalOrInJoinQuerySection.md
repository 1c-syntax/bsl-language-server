# <Diagnostic name> (LogicalOrInJoinQuerySection)

<!-- Блоки выше заполняются автоматически, не трогать -->
## Описание диагностики
Диагностика выявляет использование оператора `ИЛИ` в условиях соединений таблиц. 

Присутствие операторов `ИЛИ` в условиях соединений может привести к тому, что СУБД не сможет использовать
индексы таблиц и будет выполнять сканирование, что увеличит время работы запроса и вероятность возникновения блокировок.

Ошибка может быть решена "разнесением" предикатов условия с `ИЛИ` на разные пакеты запросов с объединением

ВАЖНО:
Диагностика контролирует наличие предикатов в условии `ИЛИ`, над различными полями, так как использование оператора `ИЛИ`
над вариантами одного поля при выполнении запроса на стороне SQL автоматически преобразуется в условие IN.
## Примеры
1) Ошибка не будет зафиксирована при использовании `ИЛИ` над вариантами одного поля

```bsl
ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры //Тест работы на вложенном соединении
ПО СправочникНоменклатура.ВидНоменклатуры = ВидыНоменклатуры.Ссылка
   И (СправочникНоменклатура.СрокГодности > 1
     ИЛИ СправочникНоменклатура.СрокГодности < 10)
```
2) При использовании оператора `ИЛИ` над различными полями ошибка будет зафиксирована для каждого вхождения оператора

```bsl
ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
ПО РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка
   И (РеализацияТоваровУслугТовары.Сумма > 0 
   ИЛИ РеализацияТоваровУслугТовары.СуммаНДС > 0 
   ИЛИ РеализацияТоваровУслугТовары.СуммаСНДС > 0)
         
```

Такие конструкции предлагается исправлять вынесением в отдельные пакеты запросов с объединением:

```bsl
ВЫБРАТЬ *
ИЗ
ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
ПО РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка
   И РеализацияТоваровУслугТовары.Сумма > 0 
   
ОБЪЕДИНИТЬ ВСЕ 

ВЫБРАТЬ *
ИЗ
ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
ПО РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка 
    И РеализацияТоваровУслугТовары.СуммаНДС > 0 
    
ОБЪЕДИНИТЬ ВСЕ 

ВЫБРАТЬ *
ИЗ
ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
ПО РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка 
    И РеализацияТоваровУслугТовары.СуммаСНДС > 0       
```

3) Диагностика также отработает для вложенных соединений с использованием `ИЛИ` в условиях.

```bsl
Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
ПО РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка
ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СправочникНоменклатура
    ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры КАК ВидыНоменклатуры //Тест работы на вложенном соединении
    ПО СправочникНоменклатура.ВидНоменклатуры = ВидыНоменклатуры.Ссылка
        И (СправочникНоменклатура.СрокГодности > 1
         ИЛИ ВидыНоменклатуры.ЗапрещенаПродажаЧерезПатент = ИСТИНА)
         
```
Рекомендуется исправление аналогично п.2 заменой вложенного соединения на соединение с созданием промежуточной временной таблицы

## Источники
- [Стандарт - Эффективные условия запросов, п.2](https://its.1c.ru/db/v8std/content/658/hdoc)
- [Использование логического ИЛИ в условиях - Типичные причины неоптимальной работы запросов и методы оптимизации](https://its.1c.ru/db/content/metod8dev/src/developers/scalability/standards/i8105842.htm#or)
